# W-13 Review (2026-02-17 11:36) - P-03 TaskManage Repository/UseCase 연동

## 범위
- 브랜치: `feature/p01-p02-p12-single-pr`
- 변경 기준 파일(핵심)
  - `app/src/main/java/com/dayquest/app/domain/repository/TaskRepository.kt`
  - `app/src/main/java/com/dayquest/app/data/repository/TaskRepositoryImpl.kt`
  - `app/src/main/java/com/dayquest/app/domain/usecase/task/*`
  - `app/src/main/java/com/dayquest/app/di/TaskModule.kt`
  - `app/src/main/java/com/dayquest/app/ui/screen/TaskManageViewModel.kt`
  - `app/src/main/java/com/dayquest/app/ui/screen/TaskManageScreen.kt`
  - `app/src/main/java/com/dayquest/app/MainActivity.kt`
  - `app/src/test/java/com/dayquest/app/domain/usecase/task/*`

## 빠른 결론
- Repository/UseCase/DI 연결 자체는 정상적으로 보이며, 단위 테스트도 기본 경로(추가/수정/삭제 위임, observe 전달)는 통과.
- 다만 **완료 처리(toggleDone)의 영속성 부재**, **에러 복구 경로 미흡**, **수정 실패 시 UX 침묵** 등 실사용/회귀 리스크가 존재.

## 리스크 점검 (기능/회귀/테스트 누락)

### 리스크 1) 완료 상태(toggleDone)가 DB/도메인에 반영되지 않음 (기능 리스크)
- 관찰:
  - `TaskManageViewModel.toggleDone()`은 `doneTaskIds`(메모리 Set)와 UI state만 변경.
  - `TaskRepository`/`TaskEntity` 어느 곳에도 완료 상태 업데이트 호출 없음.
- 영향:
  - 화면 재진입/프로세스 재시작 시 완료 상태 소실.
  - 오늘 퀘스트/통계와 상태 불일치 가능(보여주기 완료 vs 실제 데이터 미반영).
- 완화책:
  1. 완료 이벤트를 `DailyItem` 또는 `Task`의 명시적 상태 필드로 영속화.
  2. `ToggleTaskDoneUseCase`를 별도 도입해 ViewModel이 도메인 경유만 하도록 정리.
  3. 회귀 방지 테스트: "재구독/재시작 후 완료 상태 유지" 시나리오 추가.

### 리스크 2) Error 상태에서 재시도(onRetry) 동작이 비어 있음 (회귀/UX 리스크)
- 관찰:
  - `TaskManageScreen`의 `ErrorCard(onRetry = { })`가 no-op.
  - ViewModel도 공개된 재로딩 API 없음.
- 영향:
  - 일시적 DB/Flow 에러 발생 시 사용자가 복구할 수 없어 화면이 고착될 수 있음.
- 완화책:
  1. ViewModel에 `retry()` 또는 `reload()` 제공.
  2. `ErrorCard`의 onRetry를 해당 액션에 바인딩.
  3. UI 테스트/단위 테스트로 "Error -> Retry -> Ready" 전이 검증.

### 리스크 3) 수정(upsert) 시 대상 Task 미존재면 조용히 무시 (기능/UX 리스크)
- 관찰:
  - `SaveManageTaskUseCase`: `getTask(taskId) ?: return`.
  - `TaskManageViewModel.upsert()`: use case 호출 후 항상 form reset 수행.
- 영향:
  - 동시 삭제/레이스 상황에서 사용자는 저장 성공처럼 보이나 실제 반영이 안 될 수 있음.
  - 입력값 유실 가능.
- 완화책:
  1. UseCase 결과를 `Result`/sealed class로 반환(Inserted/Updated/NotFound/Error).
  2. NotFound 시 form 유지 + Snackbar/토스트 안내.
  3. 테스트 추가: "수정 대상 없음" 케이스에서 UI 반응 검증.

### 리스크 4) category를 `TaskEntity.description`에 매핑 (도메인 의미 충돌 리스크)
- 관찰:
  - `SaveManageTaskUseCase`가 category를 `description`에 저장.
  - `toTaskItemUi()`도 category를 description에서 역매핑.
- 영향:
  - 향후 실제 설명(description) 기능 추가 시 데이터 의미 충돌/마이그레이션 비용 증가.
- 완화책:
  1. 엔티티에 `category` 명시 필드 추가(스키마 마이그레이션 포함).
  2. 과도기적으로 mapper 레이어에서 호환 처리.
  3. 스키마 마이그레이션 테스트 추가.

## 테스트 누락/보강 제안
1. **ViewModel 단위 테스트**
   - `upsert()` 성공/실패/NotFound
   - `delete()` 후 편집 폼 초기화 여부
   - `toggleDone()` 이후 재구독 시 상태 일관성
2. **RepositoryImpl 테스트 (Room in-memory)**
   - `observeActiveTasks`, `softDelete`, `getTask` 동작 검증
3. **UI/통합 테스트**
   - Error retry 동작
   - 편집 중 삭제/동시성 시나리오

## 실행 확인
- 명령: `./gradlew.bat testDebugUnitTest --tests "*task*" --tests "*SyncDailyQuestsUseCaseTest*"`
- 결과: BUILD SUCCESSFUL
- 해석: 신규 UseCase 단위 테스트는 통과하나, 상기한 상태 영속/에러복구/NotFound UX는 테스트 범위 밖.

## 총평
- P-03의 "Repository/UseCase 연동" 자체는 잘 연결됨.
- 다만 실제 사용자 흐름 기준으로는 **완료 상태 영속화**, **에러 복구**, **수정 실패 피드백**이 우선 보강 포인트.
