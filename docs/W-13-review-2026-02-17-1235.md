# W-13 Review (P-03 TaskManage Repository/UseCase Refactor)

Date: 2026-02-17 12:35 (GMT+9)
Reviewer: DayQuest 리뷰 서브에이전트
Scope: current branch changes related to TaskManage Repository/UseCase refactor

## Reviewed files
- `app/build.gradle.kts`
- `app/src/main/java/com/dayquest/app/MainActivity.kt`
- `app/src/main/java/com/dayquest/app/ui/screen/TaskManageScreen.kt`
- `app/src/main/java/com/dayquest/app/ui/screen/TaskManageViewModel.kt`
- `app/src/main/java/com/dayquest/app/di/TaskModule.kt`
- `app/src/main/java/com/dayquest/app/domain/repository/TaskRepository.kt`
- `app/src/main/java/com/dayquest/app/data/repository/TaskRepositoryImpl.kt`
- `app/src/main/java/com/dayquest/app/domain/usecase/task/ObserveManageTasksUseCase.kt`
- `app/src/main/java/com/dayquest/app/domain/usecase/task/SaveManageTaskUseCase.kt`
- `app/src/main/java/com/dayquest/app/domain/usecase/task/DeleteManageTaskUseCase.kt`
- `app/src/test/java/com/dayquest/app/domain/usecase/task/ObserveManageTasksUseCaseTest.kt`
- `app/src/test/java/com/dayquest/app/domain/usecase/task/SaveManageTaskUseCaseTest.kt`
- `app/src/test/java/com/dayquest/app/domain/usecase/task/DeleteManageTaskUseCaseTest.kt`
- `app/src/test/java/com/dayquest/app/domain/usecase/today/SyncDailyQuestsUseCaseTest.kt`
- (reference check) `app/src/main/java/com/dayquest/app/data/local/dao/TaskDao.kt`
- (reference check) `app/src/main/java/com/dayquest/app/data/local/entity/TaskEntity.kt`
- (reference check) `app/src/main/java/com/dayquest/app/ui/model/TaskModels.kt`

## Risk findings

### 1) Domain/Data boundary leakage via repository contract
- Severity: **Medium**
- Area: Architecture
- Detail:
  - `TaskRepository` is placed in `domain` but directly exposes `TaskEntity` (Room/data-layer entity).
  - This tightens coupling between domain/usecase and Room schema, reducing isolation for future model changes.
- Impact:
  - Refactor cost increases if persistence model changes.
  - Harder to unit-test domain independently with pure domain models.

### 2) Error recovery path regressed in UI
- Severity: **Medium**
- Area: Regression risk / UX resiliency
- Detail:
  - In `TaskManageScreen`, `ErrorCard(onRetry = { })` is now no-op.
  - If initial flow collection fails (`TaskManageViewModel` catch block), UI can stay in error without recovery action.
- Impact:
  - User can be stuck on error state until process/lifecycle restart.

### 3) Completion(toggleDone) state is local-only and detached from repository stream
- Severity: **Medium**
- Area: Data consistency / behavior consistency
- Detail:
  - `toggleDone` mutates local `doneTaskIds` only; no persistence.
  - On fresh app process/start, completion state resets; behavior may diverge from user expectations if this screen is interpreted as persistent task completion.
  - Banner celebration computes `after` from current state snapshot in screen, not from post-DB authoritative state.
- Impact:
  - Potential inconsistency between displayed completion and stored task data.
  - Future regressions likely if completion semantics are later persisted.

### 4) Update-on-missing-id silently ignored
- Severity: **Low**
- Area: Data consistency / UX edge case
- Detail:
  - `SaveManageTaskUseCase` returns quietly when `taskId` is provided but not found.
  - `TaskManageViewModel.upsert()` still clears form after invoke.
- Impact:
  - In stale edit scenarios (task already deleted elsewhere), user input can disappear without feedback.

### 5) Test coverage gap around ViewModel + Hilt integration
- Severity: **Medium**
- Area: Test gaps / regression risk
- Detail:
  - Added unit tests cover usecases well, but no tests for:
    - `TaskManageViewModel` state transitions (loading/ready/error, form reset, delete while editing).
    - `TaskManageScreen` behavior changes (retry noop, quest banner trigger logic).
    - Hilt wiring regression (`@AndroidEntryPoint` + `TaskModule` binding).
- Impact:
  - Refactor correctness at integration/UI layer is not verified.

## Recommended next checks
1. Add `TaskManageViewModel` unit tests for:
   - initial load success/failure
   - upsert create/edit
   - delete while editing (form reset)
   - toggleDone + doneTaskIds mapping across repository re-emissions
2. Decide and document completion-state policy:
   - local-only (explicitly intended) vs persisted completion; align model and naming.
3. Implement meaningful retry action from error state:
   - e.g., reload trigger/re-collect path or state reset + re-subscribe.
4. Consider introducing domain model (`Task`) in repository contract to decouple domain from Room entities.
5. Add a small Hilt/instrumented smoke check for `TaskManageScreen`/`TaskManageViewModel` injection path.
6. Edge-case handling:
   - if edit target missing during save, keep form and surface snackbar/error.

## Validation run
- Executed (non-destructive):
  - `./gradlew.bat :app:testDebugUnitTest --tests "*ManageTask*" --tests "*SyncDailyQuestsUseCaseTest*"`
- Result: **BUILD SUCCESSFUL**
